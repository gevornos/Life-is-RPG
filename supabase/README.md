# Supabase Setup Guide

## Настройка базы данных

### 1. Создание таблицы

1. Открой Supabase Dashboard: https://supabase.com/dashboard
2. Выбери свой проект
3. Перейди в **SQL Editor** (слева в меню)
4. Нажми **New Query**
5. Скопируй весь код из файла `schema.sql`
6. Вставь в редактор и нажми **Run** (или Ctrl+Enter)

Ты должен увидеть: `Success. No rows returned`

### 2. Настройка аутентификации

В Supabase Dashboard:

1. Перейди в **Authentication** → **Providers**
2. Включи **Email** провайдер (должен быть включен по умолчанию)
3. (Опционально) В **Authentication** → **Settings** → **Email Auth**:
   - Отключи "Confirm email" если хочешь быструю регистрацию без подтверждения email
   - Для production лучше оставить включенным

### 3. Проверка RLS (Row Level Security)

1. Перейди в **Database** → **Tables**
2. Выбери таблицу `characters`
3. Вкладка **Policies**
4. Убедись что есть 4 политики:
   - Users can view own character (SELECT)
   - Users can create own character (INSERT)
   - Users can update own character (UPDATE)
   - Users can delete own character (DELETE)

## Архитектура синхронизации

### Источники истины

**Сервер (Supabase):**
- `gold` - золото (для мультиплеера и покупок)
- `gems` - алмазы (премиум валюта)

**Клиент (AsyncStorage):**
- `xp`, `level` - опыт и уровень
- `hp`, `max_hp` - здоровье
- `attributes` (strength, health, intelligence, creativity, discipline) - характеристики
- `attribute_streaks` - серии для прокачки атрибутов
- `habits`, `tasks`, `dailies` - задачи и привычки (пока локально)

### Стратегия синхронизации

1. **При авторизации**: загружаем персонажа с сервера
2. **При каждом изменении** (addXP, addGold, increaseAttribute): автоматическая синхронизация в фоне
3. **При слиянии**: берем gold/gems с сервера, остальное с клиента

### Offline режим

Приложение работает офлайн:
- Все изменения сохраняются локально
- При восстановлении соединения происходит автоматическая синхронизация
- Если синхронизация не удалась, приложение продолжает работать локально

## Тестирование

### Регистрация нового пользователя

1. Запусти приложение: `npm start`
2. Введи email и пароль
3. Нажми "Зарегистрироваться"
4. (Если включено подтверждение email) Проверь почту
5. Войди в аккаунт

### Проверка синхронизации

1. Создай персонажа
2. Выполни несколько задач (получи XP и gold)
3. Перезапусти приложение
4. Проверь что прогресс сохранился

### Проверка мультиустройства (будущее)

1. Залогинься на устройстве 1
2. Получи немного gold
3. Залогинься под тем же аккаунтом на устройстве 2
4. Убедись что gold синхронизировался

## Troubleshooting

### "User not authenticated" ошибка

- Проверь что `SUPABASE_ANON_KEY` правильно установлен в `lib/supabase.ts`
- Убедись что пользователь залогинен

### Персонаж не создается

- Проверь RLS policies в Supabase Dashboard
- Убедись что политика INSERT разрешает создание
- Проверь консоль браузера на ошибки

### Данные не синхронизируются

- Проверь интернет соединение
- Посмотри логи: `console.error` в characterService
- Убедись что Supabase URL и ключ корректны
